using Microsoft.Azure.Functions.Worker; using Microsoft.Azure.Functions.Worker.Http; using Microsoft.PowerPlatform.Dataverse.Client; using Microsoft.Xrm.Sdk; using Azure.Identity; using Azure.Core; using System; using System.Net; using System.Text.Json; using System.Threading.Tasks; public class CreateAccountFunctionMI{[Function("CreateAccountMI")] public async Task<HttpResponseData> Run([HttpTrigger(AuthorizationLevel.Function, "post")] HttpRequestData req){var body=await JsonSerializer.DeserializeAsync<CreateAccountDto>(req.Body,new JsonSerializerOptions{PropertyNameCaseInsensitive=true});var orgUrl=Environment.GetEnvironmentVariable("DATAVERSE_ORG_URL");var credential=new DefaultAzureCredential();async Task<string> AccessTokenProvider(string instanceUri){var uri=new Uri(instanceUri);var scope=$"{uri.Scheme}://{uri.Host}/.default";var token=await credential.GetTokenAsync(new TokenRequestContext(new[]{scope}));return token.Token;} using var svc=new ServiceClient(new Uri(orgUrl),AccessTokenProvider,true,null);var account=new Entity("account");account["name"]=body?.Name??"MI API Account";if(!string.IsNullOrWhiteSpace(body?.Email))account["emailaddress1"]=body!.Email;var id=svc.Create(account);var res=req.CreateResponse(System.Net.HttpStatusCode.OK);await res.WriteStringAsync(JsonSerializer.Serialize(new { id }));return res;} public class CreateAccountDto{public string? Name{get;set;} public string? Email{get;set;}}}