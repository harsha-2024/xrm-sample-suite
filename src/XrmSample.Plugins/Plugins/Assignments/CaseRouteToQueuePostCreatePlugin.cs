using System;using Microsoft.Xrm.Sdk;using Microsoft.Xrm.Sdk.Messages;using System.Web.Script.Serialization;namespace XrmSample.Plugins.Plugins.Assignments{public class CaseRouteToQueuePostCreatePlugin:XrmSample.Plugins.PluginBase{public CaseRouteToQueuePostCreatePlugin(string u,string s):base(u,s){}protected override void ExecutePlugin(IPluginExecutionContext c,IOrganizationService s,ITracingService t){if(c.MessageName!="Create"||!c.PrimaryEntityName.Equals("incident",StringComparison.OrdinalIgnoreCase))return;if(!(c.OutputParameters.Contains("id")&&c.OutputParameters["id"] is Guid caseId))return;Guid highPriorityQueue=Guid.Empty,defaultQueue=Guid.Empty;try{if(!string.IsNullOrWhiteSpace(UnsecureConfig)){var json=new JavaScriptSerializer().Deserialize<dynamic>(UnsecureConfig);if(json!=null){if(json.ContainsKey("highPriorityQueue"))Guid.TryParse(json["highPriorityQueue"],out highPriorityQueue);if(json.ContainsKey("defaultQueue"))Guid.TryParse(json["defaultQueue"],out defaultQueue);}}}catch{}int priority=2;if(c.InputParameters.Contains("Target")&&c.InputParameters["Target"] is Entity target&&target.Contains("prioritycode")){var opt=target.GetAttributeValue<OptionSetValue>("prioritycode");if(opt!=null)priority=opt.Value;}var queueId=(priority==1?highPriorityQueue:defaultQueue);if(queueId!=Guid.Empty){var add=new AddToQueueRequest{DestinationQueueId=queueId,Target=new EntityReference("incident",caseId)};s.Execute(add);} }} }