using System;using Microsoft.Xrm.Sdk;using Microsoft.Xrm.Sdk.Query;namespace XrmSample.Plugins.Plugins{public class AccountCreateValidationPlugin:XrmSample.Plugins.PluginBase{public AccountCreateValidationPlugin(string u,string s):base(u,s){}protected override void ExecutePlugin(IPluginExecutionContext c,IOrganizationService svc,ITracingService t){if(c.MessageName!="Create")return;if(!(c.InputParameters.Contains("Target")&&c.InputParameters["Target"] is Entity target))return;if(target.LogicalName!="account")return;if(target.Contains("emailaddress1")&&target["emailaddress1"] is string email&&!string.IsNullOrWhiteSpace(email)){var qe=new QueryExpression("account"){ColumnSet=new ColumnSet(false),Criteria=new FilterExpression{Conditions={new ConditionExpression("emailaddress1",ConditionOperator.Equal,email)}},TopCount=1};var exi=svc.RetrieveMultiple(qe);if(exi.Entities.Count>0)throw new InvalidPluginExecutionException("An account with the same email already exists.");}if(!target.Contains("accountnumber"))target["accountnumber"]=$"ACCT-{DateTime.UtcNow:yyyyMMddHHmmss}";}}}